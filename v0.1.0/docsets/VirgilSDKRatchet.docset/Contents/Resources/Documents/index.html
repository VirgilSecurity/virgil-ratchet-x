<!DOCTYPE html>
<html lang="en">
  <head>
    <title>VirgilSDKRatchet  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="VirgilSDKRatchet  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">VirgilSDKRatchet Docs</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">VirgilSDKRatchet Reference</a>
        <img id="carat" src="img/carat.png" />
        VirgilSDKRatchet  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/FileGroupSessionStorage.html">FileGroupSessionStorage</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/FileOneTimeKeysStorage.html">FileOneTimeKeysStorage</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/FileSessionStorage.html">FileSessionStorage</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IdentityPublicKeySet.html">IdentityPublicKeySet</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/KeychainLongTermKeysStorage.html">KeychainLongTermKeysStorage</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/KeysRotator.html">KeysRotator</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/LongTermKey.html">LongTermKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/OneTimeKey.html">OneTimeKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/PublicKeySet.html">PublicKeySet</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/RatchetClient.html">RatchetClient</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/RotationLog.html">RotationLog</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SecureChat.html">SecureChat</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SecureChatContext.html">SecureChatContext</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SecureGroupSession.html">SecureGroupSession</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SecureSession.html">SecureSession</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/SignedPublicKey.html">SignedPublicKey</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/ValidatePublicKeysResponse.html">ValidatePublicKeysResponse</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/FileOneTimeKeysStorageError.html">FileOneTimeKeysStorageError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/KeychainLongTermKeysStorageError.html">KeychainLongTermKeysStorageError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/KeysRotatorError.html">KeysRotatorError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/RatchetClientError.html">RatchetClientError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/SecureChatError.html">SecureChatError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/SecureGroupSessionError.html">SecureGroupSessionError</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/SecureSessionError.html">SecureSessionError</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/GroupSessionStorage.html">GroupSessionStorage</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/KeysRotatorProtocol.html">KeysRotatorProtocol</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/LongTermKeysStorage.html">LongTermKeysStorage</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/OneTimeKeysStorage.html">OneTimeKeysStorage</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/RatchetClientProtocol.html">RatchetClientProtocol</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/SessionStorage.html">SessionStorage</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='virgil-security-ratchet-objective-c-swift-sdk' class='heading'>Virgil Security Ratchet Objective-C/Swift SDK</h1>

<p><a href="https://travis-ci.com/VirgilSecurity/virgil-ratchet-x"><img src="https://api.travis-ci.com/VirgilSecurity/virgil-ratchet-x.svg?branch=master" alt="Build Status"></a>
<a href="https://cocoapods.org/pods/VirgilSDKRatchet"><img src="https://img.shields.io/cocoapods/v/VirgilSDKRatchet.svg" alt="CocoaPods Compatible"></a>
<a href="https://github.com/Carthage/Carthage"><img src="https://img.shields.io/badge/Carthage-compatible-4BC51D.svg?style=flat" alt="Carthage compatible"></a>
<a href="https://cocoapods.org/pods/VirgilSDKRatchet"><img src="https://img.shields.io/cocoapods/p/VirgilSDKRatchet.svg?style=flat" alt="Platform"></a>
<a href="https://github.com/VirgilSecurity/virgil/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-BSD%203--Clause-blue.svg" alt="GitHub license"></a></p>

<p><a href="#introduction">Introduction</a> | <a href="#sdk-features">SDK Features</a> | <a href="#installation">Installation</a> | <a href="#register-users">Register Users</a> | <a href="#peer-to-peer-chat-example">Peer-to-peer Chat Example</a> | <a href="#group-chat-example">Group Chat Example</a> | <a href="#support">Support</a></p>
<h2 id='introduction' class='heading'>Introduction</h2>

<p><a href="https://developer.virgilsecurity.com/docs"><img width="230px" src="https://cdn.virgilsecurity.com/assets/images/github/logos/virgil-logo-red.png" align="left" hspace="10" vspace="6"></a>
<a href="https://virgilsecurity.com">Virgil Security</a> provides a set of services and open source libraries for adding security to any application. If you&rsquo;re developing a chat application, you&rsquo;ll understand the need for a  high level of data protection to ensure confidentiality and data integrity.</p>

<p>You may have heard of our <a href="https://github.com/VirgilSecurity/virgil-e3kit-x">e3kit</a> which offers a high level of end-to-end encription, but if you need maximum protection with your application, Virgil Security presents the Double Ratchet SDK – an implementation of the <a href="https://signal.org/docs/specifications/doubleratchet/">Double Ratchet Algorithm</a>. With the powerful tools in this SDK, you can protect encrypted data, even if user messages or a private key has been stolen. The Double Ratchet SDK not only assigns a private encryption key with each chat session, but also allows the developer to limit the lifecycle of these keys. In the event an active key is stolen, it will expire according to the predetermined lifecycle you had set in your application.  </p>

<p>Ratchet SDK interacts with the <a href="https://developer.virgilsecurity.com/docs/api-reference/pfs-service/v5">PFS service</a> to publish and manage one-time keys (OTK), long-term keys (LTK), and interacts with Virgil Cards service to retrieve the user identity cards the OTK and LTK are based on. The Ratchet SDK issues chat participants new keys for every chat session. As a result new session keys cannot be used to compromise past session keys.</p>
<h1 id='sdk-features' class='heading'>SDK Features</h1>

<ul>
<li>communicate with Virgil PFS Service</li>
<li>manage users&rsquo; one-time keys (OTK) and long-term keys (LTK)</li>
<li>enable group or peer-to-peer chat encryption</li>
<li>uses the <a href="https://github.com/VirgilSecurity/virgil-crypto-c">Virgil crypto library</a> and <a href="https://github.com/VirgilSecurity/virgil-sdk-x">Virgil Core SDK</a></li>
</ul>
<h2 id='installation' class='heading'>Installation</h2>

<p>Virgil Ratchet SDK is provided as a set of frameworks distributed via Carthage and CocoaPods.</p>

<p>All frameworks are available for:</p>

<ul>
<li>iOS 9.0+</li>
<li>macOS 10.11+</li>
<li>tvOS 9.0+</li>
<li>watchOS 2.0+</li>
</ul>
<h3 id='cocoapods' class='heading'>COCOAPODS</h3>

<p><a href="http://cocoapods.org">CocoaPods</a> is a dependency manager for Cocoa projects. You can install it with the following command:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>gem install cocoapods
</code></pre>

<p>To integrate Virgil Ratchet SDK into your Xcode project using CocoaPods, specify it in your <em>Podfile</em>:</p>
<pre class="highlight shell"><code>target <span class="s1">'&lt;Your Target Name&gt;'</span> <span class="k">do
</span>use_frameworks!

pod <span class="s1">'VirgilSDKRatchet'</span>, <span class="s1">'~&gt; 0.1.0'</span>
end
</code></pre>

<p>Then, run the following command:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>pod install
</code></pre>
<h3 id='carthage' class='heading'>Carthage</h3>

<p><a href="https://github.com/Carthage/Carthage">Carthage</a> is a decentralized dependency manager that builds your dependencies and provides the binary frameworks.</p>

<p>You can install Carthage with <a href="http://brew.sh/">Homebrew</a> using the following command:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>brew update
<span class="gp">$ </span>brew install carthage
</code></pre>

<p>To integrate the Virgil Ratchet SDK into your Xcode project using Carthage, create an empty file with name <em>Cartfile</em> in your project&rsquo;s root folder and add following lines to your <em>Cartfile</em></p>
<pre class="highlight plaintext"><code>github "VirgilSecurity/virgil-ratchet-x" ~&gt; 0.1.0
</code></pre>
<h4 id='linking-against-pre-built-binaries' class='heading'>Linking against pre-built binaries</h4>

<p>To link pre-built frameworks to your app, run the following command:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>carthage update
</code></pre>

<p>This will build each dependency or download a pre-compiled framework from the github releases.</p>
<h5 id='building-for-ios-tvos-watchos' class='heading'>Building for iOS/tvOS/watchOS</h5>

<p>On your application targets’ “General&quot; settings tab, in the “Linked Frameworks and Libraries” section, add the following frameworks from the <em>Carthage/Build</em> folder inside your project&rsquo;s folder:</p>

<ul>
<li>VirgilSDKRatchet</li>
<li>VirgilSDK</li>
<li>VirgilCrypto</li>
<li>VirgilCryptoFoundation</li>
<li>VirgilCryptoRatchet</li>
<li>VSCCommon</li>
<li>VSCFoundation</li>
<li>VSCRatchet</li>
</ul>

<p>On your application targets’ “Build Phases&quot; settings tab, click the “+” icon and choose “New Run Script Phase.” Create a Run Script to specify your shell (ex: <em>/bin/sh</em>) then add the following contents:</p>
<pre class="highlight shell"><code>/usr/local/bin/carthage copy-frameworks
</code></pre>

<p>Then add the paths to the frameworks you want to use under “Input Files”, e.g.:</p>
<pre class="highlight plaintext"><code>$(SRCROOT)/Carthage/Build/iOS/VirgilSDKRatchet.framework
$(SRCROOT)/Carthage/Build/iOS/VirgilSDK.framework
$(SRCROOT)/Carthage/Build/iOS/VirgilCrypto.framework
$(SRCROOT)/Carthage/Build/iOS/VirgilCryptoFoundation.framework
$(SRCROOT)/Carthage/Build/iOS/VirgilCryptoRatchet.framework
$(SRCROOT)/Carthage/Build/iOS/VSCCommon.framework
$(SRCROOT)/Carthage/Build/iOS/VSCFoundation.framework
$(SRCROOT)/Carthage/Build/iOS/VSCRatchet.framework
</code></pre>
<h5 id='building-for-macos' class='heading'>Building for macOS</h5>

<p>On your application target&rsquo;s “General” settings tab, in the “Embedded Binaries” section, drag and drop the following frameworks from the Carthage/Build folder:</p>

<ul>
<li>VirgilSDKRatchet</li>
<li>VirgilSDK</li>
<li>VirgilCrypto</li>
<li>VirgilCryptoFoundation</li>
<li>VirgilCryptoRatchet</li>
<li>VSCCommon</li>
<li>VSCFoundation</li>
<li>VSCRatchet</li>
</ul>

<p>Additionally, you&rsquo;ll need to copy the debug symbols for debugging and crash reporting on macOS.</p>

<p>On your application target’s “Build Phases” settings tab, click the “+” icon and choose “New Copy Files Phase”.
Click the “Destination” drop-down menu and select “Product Directory.” For each framework, drag and drop the corresponding dSYM file.</p>
<h2 id='register-users' class='heading'>Register Users</h2>

<p>Make sure you have registered with the <a href="https://dashboard.virgilsecurity.com/">Virgil Dashboard</a> and have created an E2EE V5 application.</p>

<p>Besides registering on your own server, users must also be registered on the Virgil Cloud. If they already are, you can skip this step and proceed to the next one.</p>

<p>Every Virgil user has a <code>Virgil Card</code> with an unlimited life-time on their device. The card contains a <code>Private Key</code>, <code>Public Key</code>, and the user&rsquo;s <code>identity</code>.</p>

<p>To register users on the Virgil Cloud (i.e. create and publish their <code>Identity Cards</code>), follow these steps:</p>

<ul>
<li>Set up your backend to generate a JWT to provide your service and users with access to the Virgil Cloud.</li>
<li>Set up the client side for authenticating users on the Virgil Cloud.</li>
<li>Set up the Cards Manager on your client side to generate and publish <code>Virgil Card</code> with Virgil Cards Service.</li>
</ul>

<p>If you&rsquo;ve already installed the Virgil Ratchet SDK or don&rsquo;t need to install the Virgil SDK or Virgil Crypto, you can use <a href="https://developer.virgilsecurity.com/docs/how-to/public-key-management/v5/create-card">this guide</a> for the steps described above.</p>
<h3 id='initialize-sdk' class='heading'>Initialize SDK</h3>

<p>To begin communicating with the PFS service and establish a secure session, each user must run the initialization. To do that, you need the Receiver&rsquo;s public key (identity card) from Virgil Cloud and the sender&rsquo;s private key from their local storage:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">VirgilSDKRatchet</span>

<span class="k">let</span> <span class="nv">context</span> <span class="o">=</span> <span class="kt">SecureChatContext</span><span class="p">(</span><span class="nv">identityCard</span><span class="p">:</span> <span class="n">card</span><span class="p">,</span>
                                <span class="nv">identityKeyPair</span><span class="p">:</span> <span class="n">keyPair</span><span class="p">,</span>
                                <span class="nv">accessTokenProvider</span><span class="p">:</span> <span class="n">provider</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">secureChat</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">SecureChat</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>

<span class="n">secureChat</span><span class="o">.</span><span class="nf">rotateKeys</span><span class="p">()</span><span class="o">.</span><span class="n">start</span> <span class="p">{</span> <span class="n">result</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
    <span class="c1">// Keys were rotated</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">rotationLog</span><span class="p">):</span> <span class="k">break</span>
    <span class="c1">// Error occured</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span> <span class="k">break</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>During the initialization process, using Identity Cards and the <code>rotateKeys</code> method we generate special keys that have their own life-time:</p>

<ul>
<li><strong>One-time Key (OTK)</strong> - each time chat participants want to create a session, a single one-time key is obtained and discarded from the server.</li>
<li><strong>Long-term Key (LTK)</strong> - rotated periodically based on the developer&rsquo;s security considerations and is signed with the Identity Private Key.</li>
</ul>
<h2 id='peer-to-peer-chat-example' class='heading'>Peer-to-peer Chat Example</h2>

<p>In this section you&rsquo;ll find out how to build a peer-to-peer chat using the Virgil Ratchet SDK.</p>
<h3 id='send-initial-encrypted-message' class='heading'>Send initial encrypted message</h3>

<p>Let&rsquo;s assume Alice wants to start communicating with Bob and wants to send the first message:</p>

<ul>
<li>first, Alice has to create a new chat session by running the <code>startNewSessionAsSender</code> function and specify Bob&rsquo;s Identity Card</li>
<li>then, Alice encrypts the initial message using the <code>encrypt</code> SDK function</li>
<li>finally, The Ratchet SDK doesn&rsquo;t store and update sessions itself. Alice has to store the generated session locally with the <code>storeSession</code> SDK function.</li>
</ul>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">VirgilSDKRatchet</span>

<span class="c1">// prepare a message</span>
<span class="k">let</span> <span class="nv">messageToEncrypt</span> <span class="o">=</span> <span class="s">"Hello, Bob!"</span>

<span class="c1">// start new secure session with Bob</span>
<span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="k">try!</span> <span class="n">secureChat</span><span class="o">.</span><span class="nf">startNewSessionAsSender</span><span class="p">(</span><span class="nv">receiverCard</span><span class="p">:</span> <span class="n">bobCard</span><span class="p">)</span><span class="o">.</span><span class="nf">startSync</span><span class="p">()</span><span class="o">.</span><span class="nf">get</span><span class="p">()</span>

<span class="k">let</span> <span class="nv">ratchetMessage</span> <span class="o">=</span> <span class="k">try!</span> <span class="n">session</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">messageToEncrypt</span><span class="p">)</span>

<span class="k">try!</span> <span class="n">secureChat</span><span class="o">.</span><span class="nf">storeSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">encryptedMessage</span> <span class="o">=</span> <span class="n">ratchetMessage</span><span class="o">.</span><span class="nf">serialize</span><span class="p">()</span>
</code></pre>

<p><strong>Important</strong>: You need to store the session after operations that change the session&rsquo;s state (encrypt, decrypt), therefore if the session already exists in storage, it will be overwritten</p>
<h3 id='decrypt-the-initial-message' class='heading'>Decrypt the initial message</h3>

<p>After Alice generates and stores the chat session, Bob also has to:</p>

<ul>
<li>start the chat session by running the <code>startNewSessionAsReceiver</code> function</li>
<li>decrypt the encrypted message using the <code>decrypt</code> SDK function</li>
</ul>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">VirgilCryptoRatchet</span>
<span class="kd">import</span> <span class="kt">VirgilSDKRatchet</span>

<span class="k">let</span> <span class="nv">ratchetMessage</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">RatchetMessage</span><span class="o">.</span><span class="nf">deserialize</span><span class="p">(</span><span class="nv">input</span><span class="p">:</span> <span class="n">encryptedMessage</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="k">try!</span> <span class="n">secureChat</span><span class="o">.</span><span class="nf">startNewSessionAsReceiver</span><span class="p">(</span><span class="nv">senderCard</span><span class="p">:</span> <span class="n">aliceCard</span><span class="p">,</span> <span class="nv">ratchetMessage</span><span class="p">:</span> <span class="n">ratchetMessage</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">decryptedMessage</span> <span class="o">=</span> <span class="k">try!</span> <span class="n">session</span><span class="o">.</span><span class="nf">decryptString</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">ratchetMessage</span><span class="p">)</span>

<span class="k">try!</span> <span class="n">secureChat</span><span class="o">.</span><span class="nf">storeSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</code></pre>

<p><strong>Important</strong>: You need to store sessions after operations that change the session&rsquo;s state (encrypt, decrypt). If the session already exists in storage, it will be overwritten</p>
<h3 id='encrypt-and-decrypt-messages' class='heading'>Encrypt and decrypt messages</h3>
<h4 id='encrypting-messages' class='heading'>Encrypting messages</h4>

<p>To encrypt future messages, use the <code>encrypt</code> function. This function allows you to encrypt data and strings.</p>

<blockquote>
<p>You also need to use message serialization to transfer encrypted messages between users. And do not forget to update sessions in storage as their state changes with every encryption operation!</p>
</blockquote>

<ul>
<li>Use the following code-snippets to encrypt strings:</li>
</ul>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="n">secureChat</span><span class="o">.</span><span class="nf">existingSession</span><span class="p">(</span><span class="nv">withParticipantIdentity</span><span class="p">:</span> <span class="n">bobCard</span><span class="o">.</span><span class="n">identity</span><span class="p">)</span><span class="o">!</span>

<span class="k">let</span> <span class="nv">message</span> <span class="o">=</span> <span class="k">try!</span> <span class="n">session</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"Hello, Bob!"</span><span class="p">)</span>

<span class="k">try!</span> <span class="n">secureChat</span><span class="o">.</span><span class="nf">storeSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">messageData</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="nf">serialize</span><span class="p">()</span>
<span class="c1">// Send messageData to Bob</span>
</code></pre>

<ul>
<li>Use the following code-snippets to encrypt data:</li>
</ul>
<pre class="highlight plaintext"><code>let session = secureChat.existingSession(withParticipantIdentity: bobCard.identity)!

let message = try! session.encrypt(data: data)

try! secureChat.storeSession(session)

let messageData = message.serialize()
// Send messageData to Bob
</code></pre>
<h4 id='decrypting-messages' class='heading'>Decrypting Messages</h4>

<p>To decrypt messages, use the <code>decrypt</code> function. This function allows you to decrypt data and strings.</p>

<blockquote>
<p>You also need to use message serialization to transfer encrypted messages between users. And do not forget to update sessions in storage as their state changes with every decryption operation!</p>
</blockquote>

<ul>
<li>Use the following code-snippets to decrypt strings:</li>
</ul>
<pre class="highlight plaintext"><code>let session = secureChat.existingSession(withParticipantIdentity: aliceCard.identity)!

let message = try! RatchetMessage.deserialize(input: messageData)

let decryptedMessage = try! session.decryptString(from: message)

try! secureChat.storeSession(session)
</code></pre>

<ul>
<li>Use the following code-snippets to decrypt data:</li>
</ul>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="n">secureChat</span><span class="o">.</span><span class="nf">existingSession</span><span class="p">(</span><span class="nv">withParticipantIdentity</span><span class="p">:</span> <span class="n">aliceCard</span><span class="o">.</span><span class="n">identity</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">message</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">RatchetMessage</span><span class="o">.</span><span class="nf">deserialize</span><span class="p">(</span><span class="nv">input</span><span class="p">:</span> <span class="n">messageData</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">decryptedMessage</span> <span class="o">=</span> <span class="k">try!</span> <span class="n">session</span><span class="o">.</span><span class="nf">decryptData</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">message</span><span class="p">)</span>

<span class="k">try!</span> <span class="n">secureChat</span><span class="o">.</span><span class="nf">storeSession</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</code></pre>
<h2 id='group-chat-example' class='heading'>Group Chat Example</h2>

<p>In this section, you&rsquo;ll find out how to build a group chat using the Virgil Ratchet SDK.</p>
<h3 id='create-group-chat-ticket' class='heading'>Create Group Chat Ticket</h3>

<p>Let&rsquo;s assume Alice wants to start a group chat with Bob and Carol. First, create a new group session ticket by running the <code>startNewGroupSession</code> method. This ticket holds a shared root key for future group encryption. Therefore, it should be encrypted and then transmitted to other group participants. Every group chat should have a unique 32-byte session identifier. We recommend tying this identifier to your unique transport channel id. If your channel id is not 32-bytes you can use SHA-256 to derive a session id from it.</p>
<pre class="highlight plaintext"><code>// Create transport channel according to your app logic and get session id from it
let sessionId = Data(hexEncodedString: "7f4f96cedbbd192ddeb08fbf3a0f5db0da14310c287f630a551364c54864c7fb")!

let ticket = try! secureChat.startNewGroupSession(sessionId: sessionId)
</code></pre>
<h3 id='start-group-chat-session' class='heading'>Start Group Chat Session</h3>

<p>Now, start the group session by running the <code>startGroupSession</code> function. This function requires specifying the group chat session ID, the receivers&rsquo; Virgil Cards and tickets.</p>
<pre class="highlight plaintext"><code>let receiverCards = try! cardManager.searchCards(["Bob", "Carol"]).startSync().get()

let groupSession = try! secureChat.startGroupSession(with: receiverCards,
                                                     sessionId: sessionId,
                                                     using: ticket)
</code></pre>
<h3 id='store-the-group-session' class='heading'>Store the Group Session</h3>

<p>The Ratchet SDK doesn&rsquo;t store and update the group chat session itself. Use the <code>storeGroupSession</code> SDK function to store the chat sessions.</p>

<blockquote>
<p>Also, store existing session after operations that change the session&rsquo;s state (encrypt, decrypt, setParticipants, updateParticipants). If the session already exists in storage, it will be overwritten</p>
</blockquote>
<pre class="highlight swift"><code><span class="k">try!</span> <span class="n">secureChat</span><span class="o">.</span><span class="nf">storeGroupSession</span><span class="p">(</span><span class="n">groupSession</span><span class="p">)</span>
</code></pre>
<h3 id='send-the-group-ticket' class='heading'>Send the Group Ticket</h3>

<p>Next, provide the group chat ticket to other members.</p>

<ul>
<li>First, serialize the ticket</li>
</ul>
<pre class="highlight plaintext"><code>let ticketData = ticket.serialize()
</code></pre>

<ul>
<li>For security reasons, we can&rsquo;t send the unprotected ticket because it contains an unencrypted symmetric key. Therefore, we have to encrypt the serialized ticket for the receivers. The only secure way to do this is to use peer-to-peer Double Ratchet sessions with each participant to send the ticket.</li>
</ul>
<pre class="highlight plaintext"><code>for card in receiverCards {
    guard let session = secureChat.existingSession(withParticipantIdentity: card.identity) else {
        // If you don't have session, see Peer-to-peer Chat Example on how to create it as Sender.
        return
    }

    let encryptedTicket = try! session.encrypt(data: ticketData).serialize()

    try! secureChat.storeGroupSession(groupSession)

    // Send ticket to receiver
}
</code></pre>

<ul>
<li>Next, use your application&rsquo;s business logic to share the encrypted ticket with the group chat participants.</li>
</ul>
<h3 id='join-the-group-chat' class='heading'>Join the Group Chat</h3>

<p>Now, when we have the group chat created, other participants can join the chat using the group chat ticket.</p>

<ul>
<li>First, we have to decrypt the encrypted ticket</li>
</ul>
<pre class="highlight plaintext"><code>guard let session = secureChat.existingSession(withParticipantIdentity: "Alice") else {
    // If you don't have a session, see the peer-to-peer chat example on how to create it as a receiver.
    return
}

let encryptedTicketMessage = try! RatchetMessage.deserialize(input: encryptedTicket)

let ticketData = session.decryptData(from: encryptedTicketMessage)
</code></pre>

<ul>
<li>Then, use the <code>deserialize</code> function to deserialize the session ticket.</li>
</ul>
<pre class="highlight plaintext"><code>let ticket = try! RatchetGroupMessage.deserialize(input: ticketData)
</code></pre>

<ul>
<li>Join the group chat by running the <code>startGroupSession</code> function and store the session.</li>
</ul>
<pre class="highlight plaintext"><code>let receiverCards = try! cardManager.searchCards(["Alice", "Bob"]).startSync().get()

let groupSession = try! secureChat.startGroupSession(with: receiverCards,
                                                     sessionId: sessionId,
                                                     using: ticket)

try! secureChat.storeGroupSession(groupSession)
</code></pre>
<h3 id='encrypt-and-decrypt-messages' class='heading'>Encrypt and decrypt messages</h3>
<h4 id='encrypting-messages' class='heading'>Encrypting messages</h4>

<p>In order to encrypt messages for the group chat, use the <code>encrypt</code> function. This function allows you to encrypt data and strings. You still need to use message serialization to transfer encrypted messages between users. And do not forget to update sessions in storage as their state is changed with every encryption operation!</p>

<ul>
<li>Use the following code-snippets to encrypt strings:
&ldquo;`swift
let message = try! groupSession.encrypt(string: <q>Hello, Alice and Bob!</q>)</li>
</ul>

<p>try! secureChat.storeGroupSession(groupSession)</p>

<p>let messageData = message.serialize()
// Send messageData to receivers</p>
<pre class="highlight plaintext"><code>
- Use the following code-snippets to encrypt data:
```Swift
let message = try! groupSession.encrypt(data: data)

try! secureChat.storeGroupSession(groupSession)

let messageData = message.serialize()
// Send messageData to receivers
</code></pre>
<h4 id='decrypting-messages' class='heading'>Decrypting Messages</h4>

<p>To decrypt messages, use the <code>decrypt</code> function. This function allows you to decrypt data and strings. Do not forget to update sessions in storage as their state changes with every encryption operation!</p>

<ul>
<li>Use the following code-snippets to decrypt strings:
&rdquo;`Swift
let message = RatchetGroupMessage.deserialize(input: messageData)</li>
</ul>

<p>let carolCard = receiversCard.first { $0.identity == <q>Carol</q> }!</p>

<p>let decryptedMessage = try! groupSession.decryptString(from: message, senderCardId: carolCard.identifier)</p>

<p>try! secureChat.storeGroupSession(groupSession)</p>
<pre class="highlight plaintext"><code>- Use the following code-snippets to decrypt data:
```swift
let message = RatchetGroupMessage.deserialize(input: messageData)

let carolCard = receiversCard.first { $0.identity == "Carol" }!

let data = try! groupSession.decryptData(from: message, senderCardId: carolCard.identifier)

try! secureChat.storeGroupSession(groupSession)
</code></pre>
<h2 id='license' class='heading'>License</h2>

<p>This library is released under the <a href="LICENSE">3-clause BSD License</a>.</p>
<h2 id='support' class='heading'>Support</h2>

<p>Our developer support team is here to help you. Find out more information at our <a href="https://help.virgilsecurity.com/">Help Center</a>.</p>

<p>You can find us on <a href="https://twitter.com/VirgilSecurity">Twitter</a> or send us an email at <a href="mailto:support@VirgilSecurity.com">support@VirgilSecurity.com</a>.</p>

<p>Also, get extra help from our support team on <a href="https://virgilsecurity.com/join-community">Slack</a>.</p>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2019 <a class="link" href="https://virgilsecurity.com/" target="_blank" rel="external">Virgil Security</a>. All rights reserved. (Last updated: 2019-07-10)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.10.0</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
